
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Evopay</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <meta http-equiv="refresh" content="90">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
        <link rel="icon" type="image/png" href="/ticket/app_icon.png">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
       <link rel="stylesheet" type="text/css" href="/ticket/css/index.css">
    </head>    
    <body>
            <div class="container">
                <div class="row row1">
                    <img src="/ticket/images/bannertop.png" alt="Evopay Banner" id="topimagess" style="padding: 0px;">
                </div>
                <div class="row">
                    <div class="col">
                        <div class="card" id="card1">
                            <div class=card-body>
                                <h3 class="card-title"> TICKET DETAILS : </h3>
                                <h5 class="card-subtitle" style="font-size: 24px; color: #e05929; margin-bottom: 5px; margin-top: 5px"><strong>Junction Mall</strong></h5>
                                <h6 class="card-subtitle" style="font-size: 20px; color: #000000; margin-bottom: 2px; margin-top: 2px"><strong>KCC236V</strong></h6>
                                <table class="table" style="font-size: 18px;">
                                    <tbody>
                                        <tr class="tablerow">
                                            <th scope="row"> Duration : </th>
                                            <td>24 min</td>
                                        </tr>
                                        <tr class="tablerow">
                                            <th scope="row"> Parking Fee : </th>
                                            <td> KES 50</td>
                                        </tr>
                                        <tr>
                                            <th scope="row"> Service Fee : </th>
                                            <td id="servicefeetext"> KES 10</td>
                                        </tr>
                                        <tr id="voucherrow">
                                            <th scope="row"> Discount : </th>
                                            <td><span id="vouchertext">0</span></td>
                                        </tr>
                                        <tr id="totaltabel">
                                            <th scope="row"> Total </th>
                                            <td id="totalrow"> KES 60</td>
                                        </tr>
                                    </tbody>
                                </table>                      
                                <p class="card-text" style=" font-family: 'Poppins', sans-serif; font-size: 16px;">KES. <span id="totalspan" style="font-family: 'Poppins', sans-serif; font-size:70px;">60</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col" id="validatediv" style="display:none;">
                        <form action="/KCC236V/validate" id="validateform" method="get" >
                            <button class="paybtn" id="validatebtn"  type="submit"> Validate </button>  
                        </form>
                    </div>
                    <div class="col" id="paydiv" style="display: flex; justify-content: space-between;display:block;">
                        <button class="paybtn2" id="scanbtn" style="width: 150px;" type="button" data-bs-toggle="modal" data-bs-target="#scanvoucher"> Scan Voucher </button>
                        <button class="paybtn2" id="paynow" type="button" data-bs-toggle="modal" data-bs-target="#staticBackdrop"> Pay Now </button>
                    </div>
                </div>
                <br>
                <!-- Modal -->
                    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="padding: 0px;">
                            <div class="modal-header" style="border-bottom: #E25A26 solid 2px;"> 
                                <label class="col-md-10" style="text-align:center; width: 100%;font-weight: bold;"><b> Select Payment Method  </b></label>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" id="paymentForm" action="/KCC236V">

                                    <div class="card-body">
                                        <div class="regcardmodal"  style="margin-left: auto;">
                                            
                                            <div class="icon-radio">
                                                <input type="radio" name="paymentmethod" id="radio1" value="1" checked>
                                                <label for="radio1"><img src="/ticket/images/mpesalogo.png" alt="Mpesa"> Mpesa  </label>
                                            </div>
                                        
                                             <div class="icon-radio">
                                                <input type="radio" name="paymentmethod" id="radio2" value="2">
                                                <label for="radio2">
                                                    <img src="/ticket/images/airtelmoneylogo.png" alt="Airtel Money"> Airtel
                                                 </label>
                                            </div>
                                        
                                            
                                        </div>
                                        <div class="regcardmodal2">
                                            <!-- <label class="col-md-3" style="margin-right: 10px;"><b> Discounted </b></label> -->
                                            <input type="hidden" class="form-control form-control-line" value="0" name="discounted" id="discounted">
                                        </div>
                                        <div class="regcardmodal2">
                                            <label class="col-md-3" style="margin-right: 10px;"><b> Phone </b></label>
                                            <input type="number" class="form-control form-control-line" name="phoneNumber" id="phoneNumber" placeholder="07XXXXXXXX" value="0705301891">
                                        </div>
                                        <div class="regcardmodal2">
                                            <label class="col-md-3" style="margin-right: 10px;"><b> Enter KRA PIN (optional) </b></label>
                                            <input type="checkbox" class="form-controls form-control-line" value="1"  name="krapin" id="krapin" onchange="toggleCustomerPin()"><input type="hidden" name="_krapin" value="on"/>
                                        </div>
                                        <div class="regcardmodal" id="customerPinContainer" style="display: none; padding: 0px;">
                                            <div class="regcardmodal2">
                                                <label class="col-md-3" style="margin-right: 10px;"><b> KRAPIN </b></label>
                                                <input type="text" class="form-control form-control-line"  name="customerpin" id="customerpin" value="">
                                            </div>
                                        </div>
                                        <div id="error-message" class="error" style="color: red; display: none;"></div>
                                        <br>
                                        <div id="waitmessage" class="error" style="color: #E25A26; display: none;"></div>
                                        <button class="paybtn" id="paybtn" type="submit"> Pay </button>
                                    </div>
                                </form><div id="error-message" class="error"></div>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div class="modal fade" id="scanvoucher" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content" style="padding: 0px;">
                            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; width: 100%;"> 
                                <label class="col-md-10 center" style="text-align: center; flex-grow: 1; margin: 0;"><b> Scan Voucher  </b></label>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" style="color: red;" aria-label="Close" id="closemodal"></button>
                            </div>
                            <div class="modal-body">
                                <form method="POST" id="voucherForm" action="/null">
                                    <div class="card-body">
                                        <p > Please Scan your discount voucher</p>
                                        <!-- <input type="text" class="form-control form-control-line" name="vouchercode" id="vouchercode" placeholder="*********"> -->
                                        <div id="reader"></div>
                                        <div id="vouchererroressage" class="error" style="color: red; display: none;padding: 10px;"></div>
                                        <button class="paybtn" style="margin-top: 10px;display: none;" data-bs-dismiss="modal" id="applybtn" type="button"> Continue </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        </div>
                    </div> 
                    <!-- <div class="row" style="max-width: fit-content;">
                        <div class="footer">
                            <a href="/" > <button class="cardbtn"> Pay Parking </button> </a>
                        </div>
                    </div> -->
            </div>
        <script src="/ticket/js/html5-qrcode.min.js"></script>
        <script>
            function toggleCustomerPin() {
                const krapinCheckbox = document.getElementById('krapin');
                const customerPinContainer = document.getElementById('customerPinContainer');
                customerPinContainer.style.display = krapinCheckbox.checked ? 'block' : 'none';
            }

            document.getElementById('paymentForm').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent form submission
                const waitmessage = document.getElementById('waitmessage');
                const phoneInput = document.getElementById('phoneNumber');
                const errorMessage = document.getElementById('error-message');
                const paymentmethods = document.getElementsByName('paymentmethod');
                const krapinCheckbox = document.getElementById('krapin');
                const customerpin = document.getElementById('customerpin');
                const submitButton = document.getElementById('paybtn');
                let radioChecked = false;
        
                // Clear previous error message
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';

        
                // Validate radio buttons
                for (const radio of paymentmethods) {
                    if (radio.checked) {
                        radioChecked = true;
                        break;
                    }
                }
        
                if (!radioChecked) {
                    errorMessage.textContent = 'Please select a Payment Method.';
                    errorMessage.style.display = 'block';
                    return; // Stop further execution
                }

                if (!phoneInput.value || phoneInput.value.length < 10) {
                    errorMessage.textContent = 'Please enter a valid phone number.';
                    errorMessage.style.display = 'block';
                    return; // Stop further execution
                }

                // Validate phone number
                // if(krapinCheckbox.checked){
                //     if ((!customerpin.value || customerpin.value.length < 6)) {
                //         errorMessage.textContent = 'Please enter a valid KRA PIN.';
                //         errorMessage.style.display = 'block';
                //         return; // Stop further execution
                //     }
                // }

                if (krapinCheckbox.checked) {
                    const pinValue = customerpin.value; // Assuming customerpin is an input element
                    const pinFormat = /^[a-zA-Z]\d{9}[a-zA-Z]$/;
                    if (!pinValue || pinValue.length != 11 || !pinFormat.test(pinValue)) {
                    //if (!pinValue || pinValue.length != 11) {
                        errorMessage.textContent = 'Please enter a valid KRA PIN. '+pinValue;
                        errorMessage.style.display = 'block';
                        return; // Stop further execution
                    }
                }

                // If all validations pass, now submit the form programmatically
                //this.submit(); // Submit the form

                submitButton.style.display = 'none'; // Hide the submit button
                
                waitmessage.textContent = 'Please wait for prompt!';
                waitmessage.style.display = 'block';
                setTimeout(() => {
                    event.target.submit(); // Submit the form after 15 seconds
                }, 5000);
            });

            document.getElementById('scanbtn').addEventListener('click', function() {
                scanvoucher.style.display = 'block'; // Show the modal
                startCamera(); // Start the camera when the modal opens
            });
            document.getElementById('closemodal').addEventListener('click', function() {
                stopCamera();
            });


            const videoElement = document.getElementById('video');
            // const vouchertext = document.getElementById('vouchertext');
            const vouchererroressage = document.getElementById('vouchererroressage');
            const vouchercode = document.getElementById('vouchercode');
            const voucher = document.getElementById('voucher');
            const voucherrow = document.getElementById('voucherrow');
            const scanvoucher = document.getElementById('scanvoucher');
            const totalrow = document.getElementById('totalrow');
            const totalspan = document.getElementById('totalspan');
            const paynow = document.getElementById('paynow');
            
            const validatediv = document.getElementById('validatediv');
            const servicefeetext = document.getElementById('servicefeetext');
            const scanbtn = document.getElementById('scanbtn');
            const applybtn = document.getElementById('applybtn');
            const paydiv = document.getElementById('paydiv');
            const discounted = document.getElementById('discounted');
            const closemodal = document.getElementById('closemodal');
            let scanning = false;
            let html5QrCode;

            // document.getElementById('validatebtn').addEventListener('click', function() {
            document.getElementById('validateform').addEventListener('submit', function(event) {
                event.preventDefault();
                const validatebtn = document.getElementById('validatebtn');
                validatebtn.style.display = 'none';
                setTimeout(function() {
                    event.target.submit();
                }, 5000);
            });

            vouchererroressage.style.display = 'none';

            function postData(voucher) {
                const endpointUrl = '/applyvoucher'; // Replace with your endpoint URL
                const ticketids = 'KCC236V';
                const totalFee = '60';
                // const ticketids = '10';
                const body = JSON.stringify({ voucherId: voucher, ticketID: ticketids });
                //console.log("POST DATA: ", body); // Log the body being sent

                fetch(endpointUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: body,
                })
                .then(response => {
                    console.log('RESPONSE CODE :', response.statusText);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    //console.log('Success:', data); // Log the successful response
                    
                    if(data.errorCode==0){
                        var totalfeeamt = data.amount+data.servicefeeamount-data.discount;
                        var discount = data.discount;
                        if(totalfeeamt < 0)
                            totalfeeamt = 0;
                        if(data.discount > data.amount)
                            discount = data.amount;

                        vouchertext.textContent = "KES - "+discount;
                        totalspan.textContent = totalfeeamt;
                        servicefeetext.textContent = "KES "+data.servicefeeamount;
                        vouchertext.style.color = 'green';
                        totalrow.textContent = "KES "+totalfeeamt;
                        if(data.discount > 0){
                           discounted.value = 1; 
                        }
                        if(totalfeeamt==0){
                            validatediv.style.display = 'block';
                            paydiv.style.display = 'none';
                            // paynow.style.display = 'none';
                            // scanbtn.style.display = 'none';
                            applybtn.textContent = 'Continue';
                            vouchererroressage.style.color = 'green';
                            vouchererroressage.style.display = 'block';
                            vouchererroressage.textContent = "Voucher Applied Successfully!"
                            applybtn.style.display = 'block';
                        }else if(totalfeeamt > 0){
                            applybtn.style.display = 'block';
                            applybtn.textContent = 'Continue';
                            scanbtn.style.display = 'none';
                            vouchererroressage.style.color = 'green';
                            vouchererroressage.style.display = 'block';
                            vouchererroressage.textContent = "Voucher Applied Successfully!"
                        }
                    }else if(data.errorCode > 0){
                        console.log('Error:', data.desc);
                        vouchererroressage.style.display = 'block';
                        vouchererroressage.style.color = 'red';
                        vouchererroressage.textContent = "Voucher is not valid. ("+data.errorCode+")";
                        applybtn.style.display = 'block';
                        applybtn.textContent = 'Back';
                    }
                })
                .catch((error) => {
                    console.error('Error:', error); // Log the error
                });
            }

            function startCamera() {
                vouchererroressage.style.display = 'none';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        rememberLastUsedCamera: true,
                        // Only support camera scan type.
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
                        aspectRatio: 1
                        , qrbox: { width: 250, height: 250  } // Customize the size of the scanning box
                    },
                    (decodedText, decodedResult) => {
                        vouchererroressage.style.display = 'block';
                        applybtn.style.display = 'none';
                        vouchererroressage.textContent = "Validating Voucher. Please wait!";
                        stopCamera(); // Stop scanning after detection
                        postData(decodedText);
                    },
                    (errorMessage) => {
                        console.log("Error: " + errorMessage);
                    })
                .catch(err => {
                    console.error("Unable to start scanning:", err);
                });
            }

            function stopCamera() {
                if (html5QrCode) {
                    html5QrCode.stop().then(ignore => {
                        console.log("Camera stopped.");
                    }).catch(err => {
                        console.error("Error stopping camera:", err);
                    });
                }
            }



        </script>
    </body>
</html>